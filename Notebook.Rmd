---
title: "Exploratory Analysis SAT scores in Public Highschools"
output:
  html_document:
    fig_height: 4
    fig_width: 7
    theme: cosmo
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


## Reading the data
Load data
```{r}
data <- read.csv("MA_Public_Schools_2017.csv")
str(data)
```
## factors are present
```{r}
summary(data$AP_Test.Takers)
summary(data$Grade)  
```

## Subsetting to Highschools and variables of numerical value
```{r}
hs_data <- subset(data, X12_Enrollment > 0)
num <- sapply(hs_data, is.numeric)
hs_corr_data <- hs_data[,num]

hs_corr_data$AP_Test.Takers <- as.numeric(hs_data$AP_Test.Takers)
hs_corr_data$AP_Tests.Taken <- as.numeric(hs_data$AP_Tests.Taken)
hs_corr_data_cl <- hs_corr_data[colSums(!is.na(hs_corr_data)) > 40]
```

## Selecting numerical values from data for analysis
```{r}
hs_data_ready<- 
  select(hs_corr_data_cl, 
         #School.Code, Zip, 
         #District.Code,
         #SP_Enrollment, 
         TOTAL_Enrollment, 
         X..First.Language.Not.English,
         X..High.Needs,
         X..Economically.Disadvantaged,
         X..African.American,
         X..Asian,
         X..Hispanic,
         X..White,
         #X..Multi.Race..Non.Hispanic,
         X..Males,
         X..Females,
         Average.Class.Size,
         Average.Salary,
         Average.In.District.Expenditures.per.Pupil,
         Average.Expenditures.per.Pupil,
         #X..in.Cohort,
         X..GED,
         X..Non.Grad.Completers,
         X..Dropped.Out,
         X..Attending.College,
         X..Private.Four.Year,
         X..Public.Four.Year,
         X..MA.Community.College,
         X..AP_Score.3.5,
         SAT_Tests.Taken,
         Average.SAT_Reading,
         Average.SAT_Math) 
```

## Exploring Missing Data

Public schools with missing SAT & AP scores tend to come from schools with higher % of Economically disadvantaged students

The data-set only contains 394 high-schools, and the total number of high schools missing SAT test scores is 62. Meaning if we simply drop the schools with missing SAT scores I lose about 16% of my total observations.

```{r}

Data_na_scores <-
  hs_data_ready %>% 
  select( everything() ) %>%
  filter(is.na(Average.SAT_Math) 
         & is.na(Average.SAT_Reading) 
         & is.na(X..AP_Score.3.5))
```

### All Schools vs. Schools with missing scores
```{r}

summary(hs_data_ready$X..Economically.Disadvantaged)

library(ggplot2)

hs_data_ready %>%
  ggplot(aes(x=X..Economically.Disadvantaged)) + 
  ggtitle("All Schools") +
  geom_histogram(bins=20, fill = "red") +
  theme_bw()+theme(axis.title = element_text(size=16),axis.text = element_text(size=14))+
  ylab("Count") 


Data_na_scores %>%
  ggplot(aes(x=X..Economically.Disadvantaged)) + 
  ggtitle("Schools with missing scores") +
  geom_histogram(bins=20, fill = "red") +
  theme_bw()+theme(axis.title = element_text(size=16),axis.text = element_text(size=14))+
  ylab("Count") 
```

Instead I used the K Nearest Neighbor algorithm to impute the missing values. 


#let us normalize & impute

```{r}
library(caret)


trans_impute <- preProcess(hs_data_ready,
                           method = c("BoxCox", "center", "scale", "knnImpute"))
transformed_imputed <- predict(trans_impute, hs_data_ready)
```


### Comparing Original data and imputed & normalized data

Original Data
``` {r}

boxplot(hs_data_ready$X..Economically.Disadvantaged)

hs_data_ready %>%
  ggplot(aes(x=X..Economically.Disadvantaged)) + 
  ggtitle("Original Data") +
  geom_histogram(bins=20, fill = "red") +
  theme_bw()+theme(axis.title = element_text(size=16),axis.text = element_text(size=14))+
  ylab("Count") 
```

Imputed and Normalized data
``` {r}
boxplot(transformed_imputed$X..Economically.Disadvantaged)

transformed_imputed %>%
  ggplot(aes(x=X..Economically.Disadvantaged)) + 
  ggtitle("Imputed & Normalized data") +
  geom_histogram(bins=20, fill = "red") +
  theme_bw()+theme(axis.title = element_text(size=16),axis.text = element_text(size=14))+
  ylab("Count") 
```

## Relationships of Interest 

SAT Math scores were the variable of interest in these examples, since AP scores, SAT Reading and SAT Math are all highly correlated, it doesn’t really matter which of the 3 we use

```{r}
library(corrplot)
hs_data_quick<- 
  select(transformed_imputed, 
         TOTAL_Enrollment,
         X..High.Needs,
         X..Economically.Disadvantaged,
         Average.Class.Size,
         Average.Salary,
         Average.In.District.Expenditures.per.Pupil,
         Average.Expenditures.per.Pupil,
         Average.SAT_Math)

correlations_quick<-cor(x=hs_data_quick, use = "pairwise")
corrplot(correlations_quick, method = "circle", order= "hclust")
```

Expenditures per pupil are highly correlated with teacher salary, but not correlated at all with class size. Seems like teacher salary affects the public budget a lot more than class size does.

Average SAT math shows a slight negative correlation with expenditure variables. This may be due to higher expenditures in schools with more “high needs” students (as shown by correlation above), thus the expenditure vs. SAT score relationship is really dominated by the socioeconomic vs. SAT score relationship ( I will come back to this)

```{r}
a<- ggplot(transformed_imputed, aes(Average.SAT_Math, X..Economically.Disadvantaged))
a + geom_point()+
  geom_smooth(method = "lm", se = FALSE)+
  labs(title = "% of Economically Disadvantaged vs. Average SAT Math Scores")

b<- ggplot(transformed_imputed, aes(Average.SAT_Math, Average.Salary))
b + geom_point() + 
  geom_smooth(method = "lm", se = FALSE)+
  labs(title = "Average.Salary vs. Average SAT Math Scores")

c<- ggplot(transformed_imputed, aes(Average.SAT_Math, Average.Class.Size))
c + geom_point()+ 
  geom_smooth(method = "lm", se = FALSE)+
  labs(title = "Average.Class.Size vs. Average SAT Math Scores")

d<- ggplot(transformed_imputed, aes(Average.SAT_Math, Average.Expenditures.per.Pupil))
d + geom_point()+ 
  geom_smooth(method = "lm", se = FALSE)+
  labs(title = "Average.Expenditures.per.Pupil vs. Average SAT Math Scores")

e<- ggplot(transformed_imputed, aes(Average.SAT_Math, TOTAL_Enrollment))
e + geom_point() + geom_smooth(method = "lm", se = FALSE)+
  labs(title = "Total Enrollment vs. Average SAT Math Scores")
  
```
Scatter plots show a stronger relationship between Average SAT scores, (Expenditures per pupil & Total enrollment) than (Average Salary & Average Class size).

Let’s test these two groups while controlling for Economic disadvantage.

note: Since the two groups are correlated, I tested them by running two different regressions and seeing how much each variable contributed to SAT scores while controlling for Economic disadvantage.

First Group
```{r}
lm1 <- lm(Average.SAT_Math~ X..Economically.Disadvantaged + Average.Salary + Average.Class.Size, data = transformed_imputed)
summary(lm1)
```
Second Group
```{r}
lm2 <- lm(Average.SAT_Math~ X..Economically.Disadvantaged + Average.Expenditures.per.Pupil + TOTAL_Enrollment, data = transformed_imputed)
summary(lm2)
```
Seems like Average Expenditure per pupil does a better job at explaining variation in SAT test scores than Average Salary, even while controlling for economic disadvantage. The relationship is still negative though, meaning a 1 standard deviation increase in avg. expenditure per pupil is associated with a .083 standard deviation decrease in Average Math SAT scores (holding econ disadvantage & total enrollment constant)… kind of counter intuitive( I will come back to this)

Average Class size seems to explain more variation in Average Math SAT scores than TOTAL_Enrollment, even though the scatter plot showed a stronger relationship between TOTAL_Enrollment & Average Math SAT scores. This is where the beauty of linear regressions come into play, when we control for economic disadvantage in a school , we see that Total enrollment becomes irrelevant. This implies that the relationship captured by the TOTAL_Enrollment vs. Average Math SAT scatter plot is mostly due to the fact that schools with higher Total enrollment tend to have less economically disadvantaged students as a % of their population .

Based on our comparison, our final linear regression should include % of economic disadvantage, Average expenditure per pupil & Average.Class.Size.
```{r}
lm_combo <- lm(Average.SAT_Math~ X..Economically.Disadvantaged + Average.Expenditures.per.Pupil + Average.Class.Size, data = transformed_imputed)
summary(lm_combo)
```
I omitted Average.Salary because it was highly correlated with Average.Expenditure.Per.Pupil

But wait…. why is the effect of Average Expenditure per pupil on SAT Math scores negative? Suggesting that the more we spend per pupil on average will tend to drive down Average Math SAT scores… This is counter intuitive (I will come back to this).

The linear regression output also suggest almost all of the deviation in Average SAT Math Scores is due to % of Economically disadvantaged students. With 1 standard deviation increase in % of Economically disadvantaged students Average Math SAT scores decrease by about .82 standard deviations on average (holding expenditure and class size constant).

We still have some explaining/exploring to do..

## Cool visuals... so what?
The economically disadvantaged & Average class size effect on Average SAT math scores make sense, but the Average Expenditure per Pupil effect on Average SAT Math does not.

Something seems to be missing here. Even though we have a lot of information on each public highschool, we are merely comparing aggregate relationships and attempting to draw conclusions from them

We have tons of information on each public school, let’s make better use of it.

## Defining a school "type"
We can distinguish highschool types based off the different characteristics available in the data set.

I used hierarchical clustering to get an idea of how many “unique” types there are. The dendogram below illustrates the “uniqueness” or “purity” of each cluster by the vertical distance from the next break.

```{r}
#hierarichal clustering using euclidean distance 
distances <- dist(transformed_imputed, method = "euclidean")
cluster_schools <- hclust(distances, method = "ward.D")
plot(cluster_schools)

##### FAIR WARNING ####
#you will have to use a different exploratory graphing algorithm for a project with larger data, hierarichal
#clustering assigns each data point as a cluster and finds distances across all data points
#making it very computationally expensive'''
```

This dendogram shows 4 clusters with clearly distinct vertical distances. The vertical distance between Cluster 4 and a potential Cluster 5 is nearly 0, implying similarities between the two clusters (aka lack of “uniqueness”). So I stuck to 4 “distinct” clusters, or in our context; 4 distinct school types.

Creation of 4 clusters
```{r}
set.seed(88)
k=4
kmeansGroups <- kmeans(transformed_imputed, centers = k, iter.max = 1000)
school_k_clusters <- kmeansGroups$cluster
```

How many schools fall into each cluster
```{r}
table(school_k_clusters)
```

### Features of each school type


```{r}
#define new variable as cluster
head(transformed_imputed)

transformed_imputed$kmeans <- as.factor(school_k_clusters)
transformed_imputed$kmeans

str(transformed_imputed$kmeans)
head(transformed_imputed)

#Create data frame that contains mean of each variable
#by cluster
summary <-transformed_imputed %>%
  group_by(kmeans) %>%
  summarize_all(funs(mean)) 

head(summary)

#this tells you how the unique characteristics of each cluster
```

Taking a deeper look at the summary statistics across each cluster, I came to the conclusion on what characteristics defined the 4 clusters.
Cluster 1(Low Income Rural Schools):
Very high % of econ disadvantage students & high need students
Extremely small total enrollment
Mostly male students
Mostly hispanic students
Very small class sizes
Relatively low teacher pay
Very High drop out rate
Very Low % of students attending college
Low Math SAT scores

Cluster 2:
High % of econ disadvantaged student & high need students
Slightly above average total enrollment
Mostly African American & Hispanic Students
Very large class sizes
Very high teacher pay
Average drop out rate
Low % of students attending college
Very Low Math SAT scores

Cluster 3(elite schools):
Very low % of economically disadvantaged students
Large total enrollment
Mostly Asian and White students
Larger portion of females than males
Above average class size
Low drop out rate
Very Large % of students attending college
Above average teacher pay
Very high Math SAT scores

Cluster 4(avg schools):
Avg % of econ disadvantage students
Slightly below average Total Enrollment
Mostly White students
Slightly below Average Class sizes
Very low teacher pay
Slightly below average drop out rate
Below Average % of students attending college
Slightly below Avg Math SAT scores



## Relationships by school "type"
Revisiting relationships of interest by school "type"
```{r}
ec<- ggplot(transformed_imputed, aes(Average.SAT_Math, X..Economically.Disadvantaged))
ec + geom_point(aes(color = factor(kmeans))) +  
  labs(title = "% of Economically Disadvantaged vs. Average SAT Math Scores")
```

We see the clusters reside where we expect them to. (for example cluster 3 aka elite schools having the lowest % of economically disadvantaged students and highest average of Math SAT scores)

note: Cluster 1 shows schools with higher % of economically disadvantaged students than Cluster 2

### Average Expenditure per Pupil and Average SAT Math scores
```{r}
exp<- ggplot(transformed_imputed, aes(Average.SAT_Math, Average.Expenditures.per.Pupil))
exp + geom_point(aes(color = factor(kmeans))) +  
  labs(title = "Average Expenditure per Pupil vs. Average SAT Math Scores")
```

### Closer look
```{r}
exp_cl<- ggplot(transformed_imputed, aes(Average.SAT_Math, Average.Expenditures.per.Pupil, color = kmeans))
exp_cl + geom_point(aes(color = factor(kmeans)))+ labs(title = "Average Expenditure per Pupils vs. Average SAT Math Scores")+
  geom_smooth(aes(group=kmeans), method = "lm", se = FALSE) +
  facet_wrap(~kmeans)
```
As the regression output suggested, Expenditure per pupil is associated with lower Avg SAT Math scores for most schools.
Our “Elite” group or Cluster 3 is the only cluster which shows a positive relationship between Expenditures and SAT scores.
Maybe there is some reverse causality here.. Maybe the schools getting more funding tend to have a lower socioeconomic level and thus lower SAT scores.
Let’s refer back to our correlation matrix to examine this assumption:
```{r}
corrplot(correlations_quick, method = "circle", order= "hclust")
```

Seems like the % of Economically disadvantaged students at your highschool is correlated with your Expenditure per Pupil ( even more correlated with In District Expenditure, but let’s focus on just Expenditure per pupil for simplicity sake)

Let’s use a variable that is less correlated with the economic status of the students at a school, Average Salary seems to be a good alternative here.

### Average Teacher Salary and Average SAT Math score
```{r}
salary<- ggplot(transformed_imputed, aes(Average.SAT_Math, Average.Salary))
salary + geom_point(aes(color = factor(kmeans))) +  
  labs(title = "Average Teacher Salary vs. Average SAT Math Scores")
```
###Closer Look
```{r}
sal_cl<- ggplot(transformed_imputed, aes(Average.SAT_Math, Average.Salary, color = kmeans))
sal_cl + geom_point(aes(color = factor(kmeans)))+ labs(title = "Average Salary vs. Average SAT Math Scores")+
  geom_smooth(aes(group=kmeans), method = "lm", se = FALSE) +
  facet_wrap(~kmeans)
```

Still observing a less intense but similar relationship : Schools in Cluster 3 (elite schools) were the only schools to show a positive relationship between Average Salary and Average Math SAT scores.

Cluster 4(average schools) has a good amount of variation across average salary with almost no change in Average SAT scores. Implying that increasing Avg Teacher salary does not do much to increase Avg SAT Math scores.

Cluster 2’s trend line is dominated by the large amount of schools with high teacher salary and very poor Math SAT performance (seen at the top left). Outside of this, the relationship is less obvious.

Cluster 1 (Rural & Low income schools) is showing a negative relationship between teacher salary and Avg SAT Math scores (as teacher salary goes up in Rural schools, Avg SAT Math scores go down, seems counter-intuitive).

Inference: Increasing Average teacher pay tends to have a positive effect only at schools with the lowest portion of economically disadvantaged students (“elite” schools). This may be due to issues of discipline and class control at schools with a larger portion of economically disadvantaged students which mitigate the affect of more “valuable” teachers.

### Average Class Size and Average SAT Math Scores
```{r}
class<- ggplot(transformed_imputed, aes(Average.SAT_Math, Average.Class.Size))
class + geom_point(aes(color = factor(kmeans))) +  
  labs(title = "Average Class Size vs. Average SAT Math Scores")
```

### Closer Look
```{r}
class_cl<- ggplot(transformed_imputed, aes(Average.SAT_Math, Average.Class.Size, color = kmeans))
class_cl + geom_point(aes(color = factor(kmeans)))+ labs(title = "Average Class Size vs. Average SAT Math Scores")+
  geom_smooth(aes(group=kmeans), method = "lm", se = FALSE) +
  facet_wrap(~kmeans)
```
Cluster 1 (rural & low income schools) show a negative linear relationship between Average Class Size and Average SAT Math. (Cluster 1 has a lot of schools with very small class sizes)

Cluster 2 (low income schools) has less schools with small class sizes relative to cluster 1 and shows a positive linear relationship between class size and test scores

Cluster 3 & 4 show no relationship between Average Class Size and Average SAT Math Scores and have almost no schools with smaller class size

Inference: In schools with higher portion of economically disadvantaged students, discipline and class control may be an obstacle that gets in the way of learning. Smaller class sizes seem to be positively correlated with SAT scores, probably due to a more disciplined environment.

Note: that Cluster 1 (rural schools) have the most data points with small class sizes relative to the other Clusters (school types). It would be interesting to gather more data on very small class sizes in schools with varying degree of enrollment and portion of economically disadvantaged students to more accurately determine what the relationship looks like.

## Let's quantify the relationships with regression analysis:

### Cluster 1: Rural, Low Income Schools
```{r}
hs_data_Cluster1<- 
  select(transformed_imputed, 
         X..High.Needs,
         X..Economically.Disadvantaged,
         Average.Class.Size,
         Average.Salary,
         Average.In.District.Expenditures.per.Pupil,
         Average.Expenditures.per.Pupil,
         Average.SAT_Math,
         kmeans) %>%
  filter(kmeans == 1)
```
kmeans being read in as factor
```{r}
str(hs_data_Cluster1)
```
Run correlations on everything except kmeans
```{r}
correlations_cluster1<-cor(x=hs_data_Cluster1[1:7], use = "pairwise")
corrplot(correlations_cluster1, method = "circle", order= "hclust")
```

Linear regression for Cluster 1
```{r}
linear_cluster1 <- lm(Average.SAT_Math~ X..Economically.Disadvantaged + Average.Salary + Average.Class.Size, data = hs_data_Cluster1)
summary(linear_cluster1)
```
Everything is as expected except for the implied effect Average.Salary has on Avg. SAT Math score. The output suggest a 1 standard deviation increase in Teacher Salary will decrease Math SAT scores by .34 standard deviations on average, holding proportion of Economically Disadvantaged and Average Class Size constant. This seems counter intuitive so let’s explore further.

* We have a bit of a multi-collinearity issue here between X..Economically.Disadvantaged and Average.Class.Size ***

Correlation between two vars is -0.51

Meaning schools with higher proportion of economically disadvantaged students tend to have smaller class sizes

Potential for Reverse Causality: Are we paying teachers more in schools with poor SAT scores?
In other words, is there some sort of relationship between our residuals and Average.Salary (testing the zero conditional mean of errors: gauss- markov assumption — -> E[Ui|Xi] = 0). Is Average.Salary truly independent of Average SAT Math scores?
